<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <meta name="googlebot" content="noindex">
    <title>
        <%=campaign.campaign_name%>
    </title>
    <% if(campaign.reporting_start_date < date_now) { %>
        <meta http-equiv="refresh" content="10;URL=https://reporting.antennesb.fr/r/<%=campaign.campaign_crypt%>">
        <% } %>

            <!-- 
            Start date :  <%= campaign.reporting_start_date %>
            Now : <%= date_now %>
       -->
            <link rel="icon" type="image/png"
                href="https://antennesb.fr/wp-content/uploads/2020/02/cropped-Logo-AntenneSolutionsBusiness-coul01-2-32x32.png"
                sizes="32x32" />
            <link rel="icon" type="image/png"
                href="https://antennesb.fr/wp-content/uploads/2020/02/cropped-Logo-AntenneSolutionsBusiness-coul01-2-192x192.png"
                sizes="192x192" />
            <link rel="apple-touch-icon" type="image/png"
                href="https://antennesb.fr/wp-content/uploads/2020/02/cropped-Logo-AntenneSolutionsBusiness-coul01-2-180x180.png" />
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
                integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
                crossorigin="anonymous">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
            <link rel="stylesheet" type="text/css"
                href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <style>
                .modal-open {
                    overflow: auto !important;
                }

                body {
                    background: #eee;
                    font-family: Century Gothic, Verdana, Geneva, Tahoma, sans-serif;
                }

                hr {
                    margin-top: 10px;
                    border-color: #ddd;
                }
            </style>
            <!-- Google Tag Manager -->
            <script>
                (function (w, d, s, l, i) {
                    w[l] = w[l] || [];
                    w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
                    var f = d.getElementsByTagName(s)[0],
                        j = d.createElement(s),
                        dl = l != 'dataLayer'
                            ? '&l=' + l
                            : '';
                    j.async = true;
                    j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
                    f
                        .parentNode
                        .insertBefore(j, f);
                })(window, document, 'script', 'dataLayer', 'GTM-KT6H7LH');
            </script>
            <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KT6H7LH" height="0" width="0"
            style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->


    <div class="container d-flex justify-content-center">

        <div class="row">

            <!--section 1-->

            <div class="card m-3 p-3">
                <h2 class="card-title text-center">Rapport de campagne</h2>
                <div class="card-body">

                    <% if(date_now < timestamp_startdate ) { %>
                        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                            <i class="fas fa-spinner fa-pulse"></i>
                            <strong>Attention : La campagne ne débutera que <u>
                                    <%= moment(campaign.campaign_start_date).fromNow(); %>
                                </u>.</strong>
                        </div>
                        <% } %>
                            <%# if(nombre_diff_day> 31 ) { %>
                                <!-- <div
                                class="alert alert-danger alert-dismissible fade show mb-3"
                                role="alert">
                                <i class="fas fa-spinner fa-pulse"></i>
                                <strong>
                                    <a href="mailto:adtraffic@antennereunion.fr?subject=Alerte reporting" title="">Veuillez contacter le service Adtraffic.</a>
                                </strong>
                            </div>  -->
                                <%# } %>


                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">
                                            <strong>Annonceur</strong>
                                            :
                                            <%=campaign.advertiser.advertiser_name%>
                                        </li>
                                        <li class="list-group-item">
                                            <strong>Campagne</strong>
                                            :
                                            <%=campaign.campaign_name%>
                                        </li>
                                        <li class="list-group-item">
                                            <strong>Période de diffusion</strong>
                                            : Du
                                            <%= moment(campaign.campaign_start_date).format('DD/MM/YYYY') %>
                                                au
                                                <%= moment(campaign.campaign_end_date).format('DD/MM/YYYY') %>
                                        </li>
                                        <% if(date_now> timestamp_startdate) { %>
                                        <li class="list-group-item">
                                            
                                                <a type="button" href="/r/<%=campaign.campaign_crypt%>"
                                                    data-toggle="modal" data-target="#exampleModal"
                                                    class="btn btn-danger btn-lg btn-block">
                                                    <i class="fas fa-link"></i>
                                                    Générer le rapport de campagne
                                                </a>
                                                <div id="progress-bar">
                                                    <div id="progress">
                                                      <span id="progress-text"></span>
                                                    </div>
                                                </div>
                                        </li>
                                       
                                        <% } %>
                                    </ul>

                </div>
                <div class="d-flex justify-content-center">
                    <img src="/admin/photos/data_fiscal.jpg" class="card-img" style="width: 445px;">
                </div>

            </div>

            <div></div>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Génération du rapport en cours !</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Veuillez patienter, le rapport est en cours de traitement
                    <div class="d-flex justify-content-center">
                        <img src="http://pa1.narvii.com/7491/d8b2fb62d9bc8d6c042da4fd6ad5be92a8d97825r1-200-200_00.gif"
                            alt="log" style="width:200px;height:200px;">
                    </div>

                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <script>

        $(document).ready(function () {

           

            <% if (date_now > timestamp_startdate || nombre_diff_day >= 31) { %>
               
                let interval = setInterval(function () {
                        $.ajax({
                            url: "/r/taskid/<%=campaign.campaign_id%>",
                            type: "GET",
                            success: function (data) {
                                document.querySelector("#progress").style.width = data.progress + "%";
                                document.querySelector("#progress-text").innerHTML = 'Chargement du rapport à '+Math.round(data.progress,2) + "%";
                                console.log('Data.progress : ',data.progress);

                                if (data.progress >= 99 && data.progress != 100) {
                                    clearInterval(interval);
                                    location.reload();
                                }

                                if(data.progress === '100') { 
                                    clearInterval(interval);
                                }
                            }
                        });
                        
                    }, 5000);

               
               
                $.ajax({
                    method: "GET",
                    url: '/r/report/<%=campaign_crypt%>',
                    success: function (data) {
                        $("#exampleModal").hide();
                        $('body').html(data);
                        clearInterval(interval);
                    }
                })
               
            <% } %>
                  

                    //affiche la modal lors du clic du bouton
                    $('.btn').on('shown.bs.modal', function () {
                        $('#myInput').trigger('focus');
                    })

            // lors du clic du bouton affectue la requête : GET
            $('.btn').click(function () {
               // $("#exampleModal").modal("show");
                $.ajax({
                    method: "GET",
                    url: '/r/report/<%=campaign_crypt%>',
                    success: function (data) {
                        $("#exampleModal").hide();
                        location.reload();
                    }
                })
            })
        })
    </script>
    <style>
.btn-danger {border-radius: 5px 5px 0 0 !important;}
#progress-bar {
  width: 100%;
  height: 20px;
  background-color: #ddd;
  border-radius: 0 0 5px 5px;
  position: relative;
  border-top: 1px dotted #fff;
}

#progress {
  width: 10%;
  height: 100%;
  background-color: #DC3545;
  position: absolute;
  top: 0;
  left: 0;
  text-align: center;
}

#progress-text {
  color: white;
  position: relative;
  font-size:10px;
  line-height:20px;
  display: block
 /* top: 50%;
  transform: translateY(-50%);*/
}

    </style>
</body>

</html>